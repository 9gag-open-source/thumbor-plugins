language: python
python:
    - "2.7"
    - "3.3"
    - "3.4"
    - "pypy"
    - "pypy3"
matrix:
    fast_finish: true
    allow_failures:
        - python: "3.3"
        - python: "3.4"
        - python: "pypy3"
        - python: "pypy"
install:
    - sudo apt-get update -y
    - sudo apt-get -y install build-essential cmake libtool libwebp-dev unzip python-dev aptitude autoconf automake m4 nasm pkg-config libpng-dev
    - pip install setuptools

    - cd ~
    - wget https://github.com/uclouvain/openjpeg/archive/version.2.0.1.tar.gz
    - tar xf version.2.0.1.tar.gz
    - cd openjpeg-version.2.0.1
    - cmake .
    - make
    - sudo make install
    - sudo make clean

    - sudo ldconfig /usr/lib

    # install aptitude packages
    - cd ~/build/okor/thumbor-plugins
    - LDFLAGS=-lm sudo aptitude install -y $(< requirements)
    - make setup

    # installing mozjpeg before pillow (make setup) or there will be errors
    - cd ~
    - wget https://github.com/mozilla/mozjpeg/archive/v3.1.tar.gz
    - tar xf v3.1.tar.gz
    - cd mozjpeg-3.1/
    - autoreconf -fiv
    - mkdir build
    - cd build
    - sh ../configure --prefix=/usr/local
    - sudo make install

    - cd ~
    - wget https://github.com/pornel/pngquant/archive/2.5.0.tar.gz
    - tar xf 2.5.0.tar.gz
    - cd pngquant-2.5.0
    - make
    - sudo make install

    - cd ~/build/okor/thumbor-plugins
script:
    - make test
